{{ $app := (include "kubedbcom-proxysql-editor.fullname" .) }}

{{ if .Values.form.alert.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $app }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    {{- include "kubedbcom-proxysql-editor.selectorLabels" . | nindent 4 }}
    {{- if .Values.form.alert.labels }}
    {{- toYaml .Values.form.alert.labels | nindent 4 }}
    {{- end }}
{{- if .Values.form.alert.annotations }}
  annotations:
    {{- toYaml .Values.form.alert.annotations | nindent 4 }}
{{- end }}
spec:
  groups:
  {{ if .Values.form.alert.groups.database.enabled -}}
  - name: proxysql.database.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.database.rules.proxySQLInstanceDown.enabled -}}
    - alert: ProxySQLInstanceDown
      expr: proxysql_uptime_seconds_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.database.rules.proxySQLInstanceDown.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLInstanceDown.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL instance down (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL instance is down on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLServiceDown.enabled -}}
    - alert: ProxySQLServiceDown
      expr: sum by (service) (proxysql_uptime_seconds_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}) == 0
      for: {{ .Values.form.alert.groups.database.rules.proxySQLServiceDown.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLServiceDown.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL service down (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL service is down on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLTooManyConnections.enabled -}}
    - alert: ProxySQLTooManyConnections
      expr: max_over_time(proxysql_client_connections_connected{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[1m]) / proxysql_proxysql_max_connections{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} * 100 > {{.Values.form.alert.groups.database.rules.proxySQLTooManyConnections.val}}
      for: {{ .Values.form.alert.groups.database.rules.proxySQLTooManyConnections.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLTooManyConnections.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL too many connections (> {{.Values.form.alert.groups.database.rules.proxySQLTooManyConnections.val}}%) (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "More than {{.Values.form.alert.groups.database.rules.proxySQLTooManyConnections.val}}% of ProxySQL connections are in use on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLSlowQueries.enabled -}}
    - alert: ProxySQLSlowQueries
      expr: increase(proxysql_slow_queries_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[1m]) > 0
      for: {{ .Values.form.alert.groups.database.rules.proxySQLSlowQueries.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLSlowQueries.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL slow queries on (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL server proxysql has some new slow query.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLRestarted.enabled -}}
    - alert: ProxySQLRestarted
      expr: proxysql_uptime_seconds_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} < {{.Values.form.alert.groups.database.rules.proxySQLRestarted.val}}
      for: {{ .Values.form.alert.groups.database.rules.proxySQLRestarted.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLRestarted.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL restarted ({{.Values.form.alert.groups.database.rules.proxySQLRestarted.val}} second ago) (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL restarted\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLHighIncomingBytes.enabled -}}
    - alert: ProxySQLHighIncomingBytes
      expr: rate(proxysql_queries_frontends_bytes_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}",traffic_flow="received"}[1m]) > {{.Values.form.alert.groups.database.rules.proxySQLHighIncomingBytes.val}}
      for: {{ .Values.form.alert.groups.database.rules.proxySQLHighIncomingBytes.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLHighIncomingBytes.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL has high incoming bytes second (> {{.Values.form.alert.groups.database.rules.proxySQLHighIncomingBytes.val}}) (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL has high incoming bytes per second on (instance {{`{{`}} $labels.pod {{`}}`}})\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.database.rules.proxySQLHighOutgoingBytes.enabled -}}
    - alert: ProxySQLHighOutgoingBytes
      expr: rate(proxysql_queries_frontends_bytes_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}",traffic_flow="sent"}[1m]) > {{.Values.form.alert.groups.database.rules.proxySQLHighOutgoingBytes.val}}
      for: {{ .Values.form.alert.groups.database.rules.proxySQLHighOutgoingBytes.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.proxySQLHighOutgoingBytes.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL has high outgoing bytes second (> {{.Values.form.alert.groups.database.rules.proxySQLHighOutgoingBytes.val}}) (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL has high outgoing bytes per second on (instance {{`{{`}} $labels.pod {{`}}`}})\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
  {{ end -}}
  {{ if .Values.form.alert.groups.cluster.enabled -}}
  - name: proxysql.cluster.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.cluster.rules.proxysqlCLusterSyncFailure.enabled -}}
    - alert: ProxySQLCLusterSyncFailure
      expr: sum by(job) (rate(proxysql_cluster_syn_conflict_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[1m])) > {{.Values.form.alert.groups.cluster.rules.proxysqlCLusterSyncFailure.val}}
      for: {{ .Values.form.alert.groups.cluster.rules.proxysqlCLusterSyncFailure.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.cluster.rules.proxysqlCLusterSyncFailure.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQL Cluster Sync Failed ( > {{.Values.form.alert.groups.cluster.rules.proxysqlCLusterSyncFailure.val}} second,) (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "ProxySQL Cluster Sync Failed for {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.provisioner.enabled -}}
  - name: proxysql.provisioner.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.enabled -}}
    - alert: KubeDBProxySQLPhaseNotReady
      expr: kubedb_com_proxysql_status_phase{phase="NotReady",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB ProxySQL Phase NotReady (proxysql {{`{{`}} $labels.proxysql {{`}}`}})
        description: "KubeDB ProxySQL Phase not ready on {{`{{`}} $labels.proxysql {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseCritical.enabled -}}
    - alert: KubeDBProxySQLPhaseCritical
      expr: kubedb_com_proxysql_status_phase{phase="Critical",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB ProxySQL Phase Critical (proxysql {{`{{`}} $labels.proxysql {{`}}`}})
        description: "KubeDB ProxySQL Phase Critical {{`{{`}} $labels.proxysql {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.opsManager.enabled -}}
  - name: proxysql.opsManager.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.enabled -}}
    - alert: KubeDBProxySQLOpsRequestOnProgress
      expr: ops_kubedb_com_proxysqlopsrequest_status_phase{phase="Progressing",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQLOpsRequest on progress (proxysqlopsrequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}})
        description: "ProxySQLOpsRequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}} is in progressressing status\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.enabled -}}
    - alert: KubeDBProxySQLOpsRequestStatusProgressingToLong
      expr: ops_kubedb_com_proxysqlopsrequest_status_phase{phase="Progressing",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQLOpsRequest is in progressing status for too long (proxysqlopsrequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}})
        description: "ProxySQLOpsRequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}} is in progressing status for too long\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestFailed.enabled -}}
    - alert: KubeDBProxySQLOpsRequestFailed
      expr: ops_kubedb_com_proxysqlopsrequest_status_phase{phase="Failed",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.severity }}
        {{- include "kubedbcom-proxysql-editor.alertLabels" . | nindent 8 }}
      annotations:
        summary: ProxySQLOpsRequest failed (proxysqlopsrequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}})
        description: "ProxySQLOpsRequest {{`{{`}} $labels.proxysqlopsrequest {{`}}`}} failed \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
{{ end }}
