{{ $app := (include "kubedbcom-postgres-editor-options.fullname" .) }}

{{ if .Values.form.alert.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $app }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    {{- include "kubedbcom-postgres-editor-options.selectorLabels" . | nindent 4 }}
{{- if .Values.form.alert.labels }}
    {{- toYaml .Values.form.alert.labels | nindent 4 }}
{{- end }}
{{- if .Values.form.alert.annotations }}
  annotations:
    {{- toYaml .Values.form.alert.annotations | nindent 4 }}
{{- end }}
spec:
  groups:
  {{ if .Values.form.alert.groups.database.enabled -}}
  - name: postgres.database.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.database.rules.postgresInstanceDown -}}
    - alert: PostgresqlDown
      expr: pg_up{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.database.rules.postgresInstanceDown.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresInstanceDown.severity }}
        app: postgres
        alertname: postgres_instance_down
      annotations:
        summary: Postgres instance down (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Postgres instance is down on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresqlSplitBrain.enabled -}}
    - alert: PostgresqlSplitBrain
      expr: count(pg_replication_is_replica{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"} == 0) != 1
      for: {{ .Values.form.alert.groups.database.rules.postgresqlSplitBrain.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresqlSplitBrain.severity }}
        app: postgres
        alertname: postgresql_split_brain
      annotations:
        summary: Postgresql split brain (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Split Brain, too many primary Postgresql databases in read-write mode\n  {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresqlTooManyLocksAcquired.enabled -}}
    - alert: PostgresqlTooManyLocksAcquired
      expr: ((sum by (pod) (pg_locks_count{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}) ) / ( sum by (pod) (pg_settings_max_locks_per_transaction{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}) * sum by (pod) (pg_settings_max_connections{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}))) > {{.Values.form.alert.groups.database.rules.postgresqlTooManyLocksAcquired.val}}
      for: {{ .Values.form.alert.groups.database.rules.postgresqlTooManyLocksAcquired.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresqlTooManyLocksAcquired.severity }}
        app: postgres
        alertname: postgresql_too_many_locks_acquired
      annotations:
        summary: Postgresql too many locks acquired (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Too many locks acquired on the database. \n  If this alert happens frequently, we may need to increase the postgres setting max_locks_per_transaction.\n  {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresRestarted.enabled -}}
    - alert: PostgresqlRestarted
      expr: time() - pg_postmaster_start_time_seconds{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"} < {{ .Values.form.alert.groups.database.rules.postgresRestarted.val }}
      for: {{ .Values.form.alert.groups.database.rules.postgresRestarted.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresRestarted.severity }}
        app: postgres
        alertname: postgresRestarted
      annotations:
        summary: Postgresql restarted (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Postgresql restarted\n  {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresqlExporterError.enabled -}}
    - alert: PostgresqlExporterError
      expr: pg_exporter_last_scrape_error{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"} > 0
      for: {{ .Values.form.alert.groups.database.rules.postgresqlExporterError.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresqlExporterError.severity }}
        app: postgres
        alertname: postgresqlExporterError
      annotations:
        summary: Postgresql exporter error (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Postgresql exporter is showing errors. A query may be buggy in query.yaml\n  {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresqlHighRollbackRate.enabled -}}
    - alert: PostgresqlHighRollbackRate
      expr: rate(pg_stat_database_xact_rollback{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}[3m]) / rate(pg_stat_database_xact_commit{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}[3m]) > {{ .Values.form.alert.groups.database.rules.postgresqlHighRollbackRate.val }}
      for: {{ .Values.form.alert.groups.database.rules.postgresqlHighRollbackRate.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresqlHighRollbackRate.severity }}
        app: postgres
        alertname: postgresqlHighRollbackRate
      annotations:
        summary: Postgresql high rollback rate (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Ratio of transactions being aborted compared to committed is hign. {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{end -}}
    {{ if .Values.form.alert.groups.database.rules.postgresTooManyConnections.enabled -}}
    - alert: PostgresTooManyConnections
      expr: sum by (pod) (pg_stat_activity_count{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"}) >= sum by (pod) (pg_settings_max_connections{job="{{- $app -}}-stats",namespace="{{ .Release.Namespace }}"} * {{.Values.form.alert.groups.database.rules.postgresTooManyConnections.val}}) / 100
      for: {{ .Values.form.alert.groups.database.rules.postgresTooManyConnections.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.postgresTooManyConnections.severity }}
        app: postgres
        alertname: postgres_too_many_connections
      annotations:
        summary: Postgresql too many connections (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "PostgreSQL instance has too many connections . {{.Values.form.alert.groups.database.rules.postgresTooManyConnections.val}}% of Postgres connections are in use on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.provisioner.enabled -}}
  - name: postgres.provisioner.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.enabled -}}
    - alert: KubeDBPostgreSQLPhaseNotReady
      expr: kubedb_com_postgres_status_phase{phase="NotReady",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB PostgreSQL Phase NotReady (postgres {{`{{`}} $labels.postgres {{`}}`}})
        description: "KubeDB PostgreSQL Phase not ready on {{`{{`}} $labels.postgres {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseCritical.enabled -}}
    - alert: KubeDBPostgreSQLPhaseCritical
      expr: kubedb_com_postgres_status_phase{phase="Critical",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB PostgreSQL Phase Critical (postgres {{`{{`}} $labels.postgres {{`}}`}})
        description: "KubeDB PostgreSQL Phase Critical {{`{{`}} $labels.postgres {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.opsManager.enabled -}}
  - name: postgres.opsManager.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.enabled -}}
    - alert: KubeDBPostgreSQLOpsRequestOnProgress
      expr: ops_kubedb_com_postgresopsrequest_status_phase{phase="Progressing",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQLOpsRequest on progress (postgresopsrequest {{`{{`}} $labels.postgresopsrequest {{`}}`}})
        description: "PostgresOpsRequest {{`{{`}} $labels.postgresopsrequest {{`}}`}} is in progressressing status\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.enabled -}}
    - alert: KubeDBPostgreSQLOpsRequestStatusProgressingToLong
      expr: ops_kubedb_com_postgresopsrequest_status_phase{phase="Progressing",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQLOpsRequest is in progressing status for too long (postgresopsrequest {{`{{`}} $labels.postgresopsrequest {{`}}`}})
        description: "PostgresOpsRequest {{`{{`}} $labels.postgresopsrequest {{`}}`}} is in progressing status for too long\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestFailed.enabled -}}
    - alert: KubeDBPostgreSQLOpsRequestFailed
      expr: ops_kubedb_com_postgresopsrequest_status_phase{phase="Failed",app="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQLOpsRequest failed (postgresopsrequest {{`{{`}} $labels.postgresopsrequest {{`}}`}})
        description: "PostgresOpsRequest {{`{{`}} $labels.postgresopsrequest {{`}}`}} failed \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.stash.enabled -}}
  - name: postgres.stash.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.stash.rules.backupSessionFailed.enabled -}}
    - alert: PostgreSQLStashBackupSessionFailed
      expr: stash_backup_session_success * on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_appscode_com_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.stash.rules.backupSessionFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.backupSessionFailed.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQL Stash backup session failed (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash backupsession failed {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.restoreSessionFailed.enabled -}}
    - alert: PostgreSQLStashRestoreSessionFailed
      expr: stash_restore_session_success * on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_appscode_com_restoresession_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.stash.rules.restoreSessionFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.restoreSessionFailed.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQL Stash restore session failed (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash restore session failed {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.enabled -}}
    - alert: PostgreSQLStashNoBackupSessionForTooLong
      expr: time() - stash_backup_last_success_time_seconds + on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_appscode_com_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} - 1 > {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQL Stash no backup for last {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.val }} second (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash no backup for too long {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.repositoryCorrupted.enabled -}}
    - alert: PostgreSQLStashRepositoryCorrupted
      expr: stash_repository_integrity * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_appscode_com_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"}
      for: {{ .Values.form.alert.groups.stash.rules.repositoryCorrupted.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.repositoryCorrupted.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQL Stash repository corrupted (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash repository corrupted {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.enabled -}}
    - alert: PostgreSQLStashRepositoryStorageRunningLow
      expr: stash_repository_size_bytes * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_appscode_com_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.val }}
      for: {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: PostgreSQL Stash Repository storage more than {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.val }} byte. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash Repository storage running low {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.enabled -}}
    - alert: PostgreSQLStashBackupSessionPeriodTooLong
      expr: stash_backup_session_duration_seconds * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_appscode_com_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary:  PostgreSQL Stash backup session took more than {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.val }} second to complete. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash backup session taking to long to complete {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.enabled -}}
    - alert: PostgreSQLStashRestoreSessionPeriodTooLong
      expr: stash_restore_session_duration_seconds * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_appscode_com_restoresession_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary:  PostgreSQL Stash restore session took more than {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.val }} second to complete. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "PostgreSQL Stash restore session taking to long to complete {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.schemaManager.enabled -}}
  - name: postgres.schemaManager.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.enabled -}}
    - alert: KubeDBPostgreSQLSchemaPendingForTooLong
      expr: schema_kubedb_com_postgresdatabase_status_phase{phase="Pending",app="{{ $app }}",app_namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema pending for too long for (postgresdatabase {{`{{`}} $labels.postgresdatabase {{`}}`}})
        description: "KubeDB schema pending for too long.\n {{`{{`}} $labels.postgresdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.enabled -}}
    - alert: KubeDBPostgreSQLSchemaInProgressForTooLong
      expr: schema_kubedb_com_postgresdatabase_status_phase{phase="InProgress",app="{{ $app }}",app_namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema is in progress for too long for (postgresdatabase {{`{{`}} $labels.postgresdatabase {{`}}`}})
        description: "KubeDB schema is in progress for too long.\n {{`{{`}} $labels.postgresdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.enabled -}}
    - alert: KubeDBPostgreSQLSchemaTerminatingForTooLong
      expr: schema_kubedb_com_postgresdatabase_status_phase{phase="Terminating",app="{{ $app }}",app_namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema terminating for too long for (postgresdatabase {{`{{`}} $labels.postgresdatabase {{`}}`}})
        description: "KubeDB schema terminating for too long.\n {{`{{`}} $labels.postgresdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaFailed.enabled -}}
    - alert: KubeDBPostgreSQLSchemaFailed
      expr: schema_kubedb_com_postgresdatabase_status_phase{phase="Failed",app="{{ $app }}",app_namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaFailed.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema failed for (postgresdatabase {{`{{`}} $labels.postgresdatabase {{`}}`}})
        description: "KubeDB schema failed.\n {{`{{`}} $labels.postgresdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaExpired.enabled -}}
    - alert: KubeDBPostgreSQLSchemaExpired
      expr: schema_kubedb_com_postgresdatabase_status_phase{phase="Expired",app="{{ $app }}",app_namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaExpired.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaExpired.severity }}
        {{- include "kubedbcom-postgres-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema expired for (postgresdatabase {{`{{`}} $labels.postgresdatabase {{`}}`}})
        description: "KubeDB schema expired.\n {{`{{`}} $labels.postgresdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
{{ end }}
