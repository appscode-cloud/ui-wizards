{{ $app := (include "kubedbcom-mongodb-editor-options.fullname" .) }}

{{ if .Values.form.alert.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $app }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kubedbcom-mongodb-editor-options.labels" . | nindent 4 }}
{{- if .Values.form.alert.labels }}
    {{- toYaml .Values.form.alert.labels | nindent 4 }}
{{- end }}
{{- if .Values.form.alert.annotations }}
  annotations:
    {{- toYaml .Values.form.alert.annotations | nindent 4 }}
{{- end }}
spec:
  groups:
  {{ if .Values.form.alert.groups.database.enabled -}}
    - name: mongodb.database.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.database.rules.mongodbVirtualMemoryUsage.enabled -}}
    - alert: MongodbVirtualMemoryUsage
      expr: sum(mongodb_memory{type="virtual",job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}) BY (job) > {{ .Values.form.alert.groups.database.rules.mongodbVirtualMemoryUsage.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbVirtualMemoryUsage.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbVirtualMemoryUsage.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB virtual memory usage (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "High memory usage\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbReplicationLag.enabled -}}
    - alert: MongodbReplicationLag
      expr: mongodb_mongod_replset_member_replication_lag{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.database.rules.mongodbReplicationLag.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbReplicationLag.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbReplicationLag.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB database has replication lag (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Mongodb replication lag is more than {{ .Values.form.alert.groups.database.rules.mongodbReplicationLag.val }}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbNumberCursorsOpen.enabled -}}
    - alert: MongodbNumberCursorsOpen
      expr: mongodb_mongod_metrics_cursor_open{state="total",job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.database.rules.mongodbNumberCursorsOpen.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbNumberCursorsOpen.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbNumberCursorsOpen.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB number cursors open (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Too many cursors opened by MongoDB for clients (> 10k)\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbCursorsTimeouts.enabled -}}
    - alert: MongodbCursorsTimeouts
      expr: increase(mongodb_mongod_metrics_cursor_timed_out_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[1m]) > {{ .Values.form.alert.groups.database.rules.mongodbCursorsTimeouts.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbCursorsTimeouts.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbCursorsTimeouts.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB cursors timeouts (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Too many cursors are timing out\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbTooManyConnections.enabled -}}
    - alert: MongodbTooManyConnections
      expr: avg by(instance) (rate(mongodb_connections{state="current",job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[1m])) / avg by(instance) (sum (mongodb_connections) by (instance)) * 100 > {{ .Values.form.alert.groups.database.rules.mongodbTooManyConnections.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbTooManyConnections.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbTooManyConnections.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB too many connections (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Too many connections (> 80%)\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongoDBPhaseCritical.enabled -}}
    - alert: MongoDBPhaseCritical
      expr: kubedb_mongodb_status_phase{mongodb="{{ $app }}", namespace="{{ .Release.Namespace }}",phase="Critical"} >= 1
      for: {{ .Values.form.alert.groups.database.rules.mongoDBPhaseCritical.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongoDBPhaseCritical.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB database is in Critical state (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Database in Critical state, one or more database nodes are not working properly.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongoDBDown.enabled -}}
    - alert: MongoDBDown
      expr: kubedb_mongodb_status_phase{mongodb="{{ $app }}", namespace="{{ .Release.Namespace }}",phase="NotReady"} >= 1
      for: {{ .Values.form.alert.groups.database.rules.mongoDBDown.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongoDBDown.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB database is in NotReady state (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Database in NotReady state, database read/write is failing.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbHighLatency.enabled -}}
    - alert: MongoDBHighLatency
      expr: |
        rate(mongodb_mongod_op_latencies_latency_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[5m]) /
        rate(mongodb_mongod_op_latencies_ops_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[5m]) > {{ .Values.form.alert.groups.database.rules.mongodbHighLatency.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbHighLatency.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbHighLatency.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: High latency in mongodb instances {{`{{`}} $labels.instance {{`}}`}}
        description: "High latency in instances\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbHighTicketUtilization.enabled -}}
    - alert: MongoDBHighTicketUtilization
      expr: |
        (mongodb_mongod_wiredtiger_concurrent_transactions_out_tickets{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"} /
        mongodb_mongod_wiredtiger_concurrent_transactions_total_tickets{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}) * 100
        > {{ .Values.form.alert.groups.database.rules.mongodbHighTicketUtilization.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbHighTicketUtilization.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbHighTicketUtilization.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: Ticket usage over 75% {{`{{`}} $labels.instance {{`}}`}}
        description: "Ticket usage over 75%\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbRecurrentCursorTimeout.enabled -}}
    - alert: MongoDBRecurrentCursorTimeout
      expr: rate(mongodb_mongod_metrics_cursor_timed_out_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[5m]) > {{ .Values.form.alert.groups.database.rules.mongodbRecurrentCursorTimeout.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbRecurrentCursorTimeout.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbRecurrentCursorTimeout.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: Recurrent cursors timeout in instance {{`{{`}} $labels.instance {{`}}`}}
        description: "Recurrent cursors timeout\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.database.rules.mongodbRecurrentMemoryPageFaults.enabled -}}
    - alert: MongoDBRecurrentMemoryPageFaults
      expr: rate(mongodb_extra_info_page_faults_total{job="{{ $app }}-stats",namespace="{{ .Release.Namespace }}"}[5m]) > {{ .Values.form.alert.groups.database.rules.mongodbRecurrentMemoryPageFaults.val }}
      for: {{ .Values.form.alert.groups.database.rules.mongodbRecurrentMemoryPageFaults.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.database.rules.mongodbRecurrentMemoryPageFaults.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: Recurrent memory page faults in instance {{`{{`}} $labels.instance {{`}}`}}
        description: "Recurrent memory page faults\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{end -}}
  {{ if .Values.form.alert.groups.provisioner.enabled -}}
  - name: mongodb.provisioner.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.enabled -}}
    - alert: KubeDBMongoDBPhaseNotReady
      expr: kubedb_mongodb_status_phase{phase="NotReady",mongodb="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseNotReady.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB MongoDB Phase NotReady (mongodb {{`{{`}} $labels.mongodb {{`}}`}})
        description: "KubeDB MongoDB Phase not ready on {{`{{`}} $labels.mongodb {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.provisioner.rules.appPhaseCritical.enabled -}}
    - alert: KubeDBMongoDBPhaseCritical
      expr: kubedb_mongodb_status_phase{phase="Critical",mongodb="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.provisioner.rules.appPhaseCritical.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB MongoDB Phase Critical (mongodb {{`{{`}} $labels.mongodb {{`}}`}})
        description: "KubeDB MongoDB Phase Critical {{`{{`}} $labels.mongodb {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.opsManager.enabled -}}
  - name: mongodb.opsManager.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.enabled -}}
    - alert: KubeDBMongoDBOpsRequestOnProgress
      expr: kubedb_mongodb_opsrequest_status_phase{phase="Progressing",database_ref="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestOnProgress.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDBOpsRequest on progress (mongodbopsrequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}})
        description: "MaraiDBOpsRequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}} is in progressressing status\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.enabled -}}
    - alert: KubeDBMongoDBOpsRequestStatusProgressingToLong
      expr: kubedb_mongodb_opsrequest_status_phase{phase="Progressing",database_ref="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestStatusProgressingToLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDBOpsRequest is in progressing status for too long (mongodbopsrequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}})
        description: "MaraiDBOpsRequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}} is in progressing status for too long\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.opsManager.rules.opsRequestFailed.enabled -}}
    - alert: KubeDBMongoDBOpsRequestFailed
      expr: kubedb_mongodb_opsrequest_status_phase{phase="Failed",database_ref="{{ $app }}",namespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.opsManager.rules.opsRequestFailed.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDBOpsRequest failed (mongodbopsrequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}})
        description: "MaraiDBOpsRequest {{`{{`}} $labels.mongodbopsrequest {{`}}`}} failed \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.stash.enabled -}}
  - name: mongodb.stash.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.stash.rules.backupSessionFailed.enabled -}}
    - alert: MongoDBStashBackupSessionFailed
      expr: stash_backup_session_success * on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.stash.rules.backupSessionFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.backupSessionFailed.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB Stash backup session failed (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash backupsession failed {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.restoreSessionFailed.enabled -}}
    - alert: MongoDBStashRestoreSessionFailed
      expr: stash_restore_session_success * on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_restoresession_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} == 0
      for: {{ .Values.form.alert.groups.stash.rules.restoreSessionFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.restoreSessionFailed.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB Stash restore session failed (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash restore session failed {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.enabled -}}
    - alert: MongoDBStashNoBackupSessionForTooLong
      expr: time() - stash_backup_last_success_time_seconds + on(invoker_name, invoker_kind) group_left(target_name, target_kind) stash_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} - 1 > {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB Stash no backup for last {{ .Values.form.alert.groups.stash.rules.noBackupSessionForTooLong.val }} second (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash no backup for too long {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.repositoryCorrupted.enabled -}}
    - alert: MongoDBStashRepositoryCorrupted
      expr: stash_repository_integrity * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"}
      for: {{ .Values.form.alert.groups.stash.rules.repositoryCorrupted.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.repositoryCorrupted.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB Stash repository corrupted (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash repository corrupted {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.enabled -}}
    - alert: MongoDBStashRepositoryStorageRunningLow
      expr: stash_repository_size_bytes * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.val }}
      for: {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: MongoDB Stash Repository storage more than {{ .Values.form.alert.groups.stash.rules.repositoryStorageRunningLow.val }} byte. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash Repository storage running low {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.enabled -}}
    - alert: MongoDBStashBackupSessionPeriodTooLong
      expr: stash_backup_session_duration_seconds * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_backupconfiguration_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary:  MongoDB Stash backup session took more than {{ .Values.form.alert.groups.stash.rules.backupSessionPeriodTooLong.val }} second to complete. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash backup session taking to long to complete {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.enabled -}}
    - alert: MongoDBStashRestoreSessionPeriodTooLong
      expr: stash_restore_session_duration_seconds * on(invoker_name, invoker_kind) group_left(target_name, target_kind, repository) stash_restoresession_info{target_name="{{ $app }}", target_kind="AppBinding", namespace="{{ .Release.Namespace }}"} > {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.val }}
      for: {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary:  MongoDB Stash restore session took more than {{ .Values.form.alert.groups.stash.rules.restoreSessionPeriodTooLong.val }} second to complete. (invoker_name {{`{{`}} $labels.invoker_name {{`}}`}})
        description: "MongoDB Stash restore session taking to long to complete {{`{{`}} $labels.invoker_name {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ if .Values.form.alert.groups.schemaManager.enabled -}}
  - name: mongodb.schemaManager.{{ .Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.enabled -}}
    - alert: KubeDBMongoDBSchemaPendingForTooLong
      expr: kubedb_mongodb_schema_status_phase{phase="Pending",serverRefName="{{ $app }}",serverRefNamespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaPendingForTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema pending for too long for (mongodbdatabase {{`{{`}} $labels.mongodbdatabase {{`}}`}})
        description: "KubeDB schema pending for too long.\n {{`{{`}} $labels.mongodbdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.enabled -}}
    - alert: KubeDBMongoDBSchemaInProgressForTooLong
      expr: kubedb_mongodb_schema_status_phase{phase="InProgress",serverRefName="{{ $app }}",serverRefNamespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaInProgressForTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema is in progress for too long for (mongodbdatabase {{`{{`}} $labels.mongodbdatabase {{`}}`}})
        description: "KubeDB schema is in progress for too long.\n {{`{{`}} $labels.mongodbdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.enabled -}}
    - alert: KubeDBMongoDBSchemaTerminatingForTooLong
      expr: kubedb_mongodb_schema_status_phase{phase="Terminating",serverRefName="{{ $app }}",serverRefNamespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaTerminatingForTooLong.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema terminating for too long for (mongodbdatabase {{`{{`}} $labels.mongodbdatabase {{`}}`}})
        description: "KubeDB schema terminating for too long.\n {{`{{`}} $labels.mongodbdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaFailed.enabled -}}
    - alert: KubeDBMongoDBSchemaFailed
      expr: kubedb_mongodb_schema_status_phase{phase="Failed",serverRefName="{{ $app }}",serverRefNamespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaFailed.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaFailed.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema failed for (mongodbdatabase {{`{{`}} $labels.mongodbdatabase {{`}}`}})
        description: "KubeDB schema failed.\n {{`{{`}} $labels.mongodbdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if .Values.form.alert.groups.schemaManager.rules.schemaExpired.enabled -}}
    - alert: KubeDBMongoDBSchemaExpired
      expr: kubedb_mongodb_schema_status_phase{phase="Expired",serverRefName="{{ $app }}",serverRefNamespace="{{ .Release.Namespace }}"} == 1
      for: {{ .Values.form.alert.groups.schemaManager.rules.schemaExpired.duration }}
      labels:
        severity: {{ .Values.form.alert.groups.schemaManager.rules.schemaExpired.severity }}
        {{- include "kubedbcom-mongodb-editor-options.alertLabels" . | nindent 8 }}
      annotations:
        summary: KubeDB schema expired for (mongodbdatabase {{`{{`}} $labels.mongodbdatabase {{`}}`}})
        description: "KubeDB schema expired.\n {{`{{`}} $labels.mongodbdatabase {{`}}`}} \n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
{{ end }}
