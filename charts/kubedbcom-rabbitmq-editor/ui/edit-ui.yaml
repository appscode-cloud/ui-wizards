type: multi-step-form
step:
- type: single-step-form
  id: compute-autoscaler
  loader: getDbDetails
  elements:
    - type: block-layout
      if:
        type: function
        name: isConsole
      elements:
        - type: input
          label: Name
          schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/metadata/properties/name
        - type: select
          label: Select Namespace
          loader: getNamespaces
          if:
            type: function
            name: isRancherManaged
          schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/metadata/properties/namespace
          watcher:
            func: onNamespaceChange
            paths:
              - schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/metadata/properties/namespace
        - type: select
          label: Select Db
          loader: getDbs
          validation:
            type: required
          refresh: true
          schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/databaseRef/properties/name
          watcher:
            func: initMetadata
            paths:
              - schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/databaseRef/properties/name

    - type: radio
      if:
        type: function
        name: isConsole
      label: Select Type
      validation:
        type: required
      schema: temp/properties/autoscalingType
      watcher:
        func: initMetadata
        paths:
          - temp/properties/autoscalingType
      options:
        - text: Compute
          value: compute
          description: Scale your CPU Memory based on resource usage
        - text: Storage
          value: storage
          description: Expand your database size based on volume usage

    - type: block-layout
      showLabels: false
      loader: fetchTopologyMachines
      elements:
        # rabbitmq mode
        - type: block-layout
          label: RabbitMQ
          showLabels: true
          # schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq
          elements:
            - type: select
              label: Trigger
              init:
                type: func
                value: setTrigger|autoscalingKubedbComRabbitMQAutoscaler/spec/compute/rabbitmq/trigger
              options:
                - text: 'On'
                  value: 'On'
                - text: 'Off'
                  value: 'Off'
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/trigger
            - type: input
              label: Pod LifeTime Threshold
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/podLifeTimeThreshold
            - type: threshold-input
              label: Resource Diff Percentage
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/resourceDiffPercentage
            - type: block-layout
              showLabels: false
              elements:
                - type: horizontal-layout
                  elements:
                  - type: machine-compare
                    label: Min Allowed Profile
                    schema: temp/properties/allowedMachine-min
                    if:
                      type: function
                      name: hasAnnotations
                    init:
                      type: func
                      value: setAllowedMachine|min
                    loader:
                      name: getMachines|min
                      watchPaths:
                        - temp/properties/topologyMachines
                        - temp/properties/allowedMachine-max
                    watcher:
                      func: onMachineChange|rabbitmq
                      paths:
                        - temp/properties/allowedMachine-min
                  - type: block-layout
                    label: Min Allowed
                    if:
                      type: function
                      name: hasNoAnnotations
                    showLabels: true
                    elements:
                      - type: input-compare
                        label: Cpu
                        schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/minAllowed/properties/cpu
                      - type: input-compare
                        label: Memory
                        schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/minAllowed/properties/memory
                  - type: machine-compare
                    label: Max Allowed Profile
                    schema: temp/properties/allowedMachine-max
                    if:
                      type: function
                      name: hasAnnotations
                    init:
                      type: func
                      value: setAllowedMachine|max
                    loader:
                      name: getMachines|max
                      watchPaths:
                        - temp/properties/topologyMachines
                        - temp/properties/allowedMachine-min
                    watcher:
                      func: onMachineChange|rabbitmq
                      paths:
                        - temp/properties/allowedMachine-max
                  - type: block-layout
                    label: Max Allowed
                    if:
                      type: function
                      name: hasNoAnnotations
                    showLabels: true
                    elements:
                      - type: input-compare
                        label: Cpu
                        schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/maxAllowed/properties/cpu
                      - type: input-compare
                        label: Memory
                        schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/maxAllowed/properties/memory
            - type: select
              label: Controlled Resources
              loader: setControlledResources|rabbitmq
              multiple: true
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/rabbitmq/properties/controlledResources

        - type: block-layout
          label: Node Topology
          if:
            type: function
            name: hasNoAnnotations
          showLabels: true
          # schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/nodeTopology
          elements:
            - type: select
              label: Select Node Topology
              loader: fetchNodeTopology
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/nodeTopology/properties/name
            - type: threshold-input
              label: ScaleUp Diff Percentage
              if:
                type: function
                name: isNodeTopologySelected
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/nodeTopology/properties/scaleUpDiffPercentage
            - type: threshold-input
              label: ScaleDown Diff Percentage
              if:
                type: function
                name: isNodeTopologySelected
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/compute/properties/nodeTopology/properties/scaleDownDiffPercentage

        - type: block-layout
          label: Ops Request Options
          showLabels: true
          if:
            type: function
            name: showOpsRequestOptions
          # schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/opsRequestOptions
          elements:
            - type: time-picker
              label: Timeout
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/opsRequestOptions/properties/timeout
            - type: radio
              label: Apply
              init:
                type: func
                value: setApplyToIfReady
              options:
                - text: IfReady (OpsRequest will be applied if database is ready)
                  value: IfReady
                - text: Always (OpsRequest will always be applied)
                  value: Always
              schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/opsRequestOptions/properties/apply
- type: single-step-form
  id: storage-autoscaler
  elements:
  - type: block-layout
    showLabels: false
    elements:
      - type: block-layout
        showLabels: false
        elements:
          - type: block-layout
            label: RabbitMQ
            showLabels: true
            elements:
              - type: select
                label: Trigger
                init:
                  type: func
                  value: setTrigger|autoscalingKubedbComRabbitMQAutoscaler/spec/storage/rabbitmq/trigger
                options:
                  - text: 'On'
                    value: 'On'
                  - text: 'Off'
                    value: 'Off'
                schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/trigger
              - type: select
                label: Expansion Mode
                options:
                  - text: Online
                    value: Online
                  - text: Offline
                    value: Offline
                schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/expansionMode
              - type: threshold-input
                label: UsageThreshold (%)
                schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/usageThreshold
              - type: scaling-rules
                label: Scaling Rules
                schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/scalingRules
                loader: setValueFromDbDetails|resources/kubedbComRabbitMQ/spec/storage/resources/requests/storage
                watcher:
                  func: handleUnit|autoscalingKubedbComRabbitMQAutoscaler/spec/storage/rabbitmq/scalingRules|scalingRules
                  paths:
                    - schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/scalingRules
              - type: input
                label: UpperBound
                schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/upperBound
                watcher:
                  func: handleUnit|autoscalingKubedbComRabbitMQAutoscaler/spec/storage/rabbitmq/upperBound
                  paths:
                    - schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/storage/properties/rabbitmq/properties/upperBound
      - type: block-layout
        label: OpsRequest Options
        showLabels: true
        if:
          type: function
          name: showOpsRequestOptions
        elements:
          - type: time-picker
            label: Timeout
            schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/opsRequestOptions/properties/timeout
          - type: radio
            label: Apply
            init:
              type: func
              value: setApplyToIfReady
            options:
              - text: IfReady (OpsRequest will be applied if database is ready)
                value: IfReady
              - text: Always (OpsRequest will always be applied)
                value: Always
            schema: schema/properties/resources/properties/autoscalingKubedbComRabbitMQAutoscaler/properties/spec/properties/opsRequestOptions/properties/apply

- type: single-step-form
  id: monitoring
  elements:
  - type: label-element
    label: To update Exporter Resource section click on Create OpsRequest
  - type: anchor
    label: Create OpsRequest
    schema: temp/properties/opsRequestUrl
    init:
      type: func
      value: getOpsRequestUrl|VerticalScaling
  - type: switch
    label: Enable Monitoring
    schema: temp/properties/enableMonitoring
    init: 
      type: func
      value: isValueExistInModel|/resources/kubedbComRabbitMQ/spec/monitor
    watcher:
      func: onEnableMonitoringChange
      paths:
        - temp/properties/enableMonitoring
  - type: block-layout
    label: Backup form 
    showLabels: false
    if:
      type: function
      name: showMonitoringSection
    elements:
      - type: radio
        label: Select a Monitoring Method
        schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/agent
        isHorizontal: true
        options:
        - text: Prometheus Operator
          value: prometheus.io/operator
          description: Inject metric exporter sidecar and creates a ServiceMonitor
        - text: Custom ServiceMonitor
          value: prometheus.io
          description: Injects the metric exporter sidecar and let you customize ServiceMonitor
        - text: Custom Scrapper
          value: prometheus.io/builtin
          description: Inject metric exporter sidecar and add Prometheus annotations to the stats Service
        init:
          type: static
          value: prometheus.io/operator
        watcher:
          func: onAgentChange
          paths:
            - schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/agent
      - type: block-layout
        label: ServiceMonitor Configuration  
        showLabels: true 
        if: 
          type: function
          name: isEqualToModelPathValue|prometheus.io/operator|/resources/kubedbComRabbitMQ/spec/monitor/agent
        elements:
          - label: Scrapping Interval
            schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/serviceMonitor/properties/interval
            type: input 
      - type: block-layout
        label: Service Monitor
        showLabels: true
        if:
          type: function
          name: isEqualToModelPathValue|prometheus.io|/resources/kubedbComRabbitMQ/spec/monitor/agent
        elements:
        - type: array-object-form
          label: Endpoints
          schema: schema/properties/resources/properties/monitoringCoreosComServiceMonitor/properties/spec/properties/endpoints
          elements:
          - type: switch
            label: Honor labels
            schema: honorLabels
          - type: input
            label: Interval
            schema: interval
          - type: input
            label: Path
            schema: path
          - type: input
            label: Port
            schema: port
        - type: select
          multiple: true
          label: Match Namespaces
          schema: schema/properties/resources/properties/monitoringCoreosComServiceMonitor/properties/spec/properties/namespaceSelector/properties/matchNames
          loader: getResources|core|v1|namespaces
          if: 
            type: function
            name: returnFalse
        - type: block-layout
          showLabels: false
          # schema: schema/properties/resources/properties/monitoringCoreosComServiceMonitor/properties/spec/properties/selector
          if: 
            type: function
            name: returnFalse
          elements:
            - type: object-item
              label: Labels
              schema: schema/properties/resources/properties/monitoringCoreosComServiceMonitor/properties/spec/properties/selector/properties/matchLabels
      - type: object-item
        schema: schema/properties/resources/properties/monitoringCoreosComServiceMonitor/properties/metadata/properties/labels
        label : Labels
        if:
          type: function
          name: isEqualToModelPathValue|prometheus.io|/resources/kubedbComRabbitMQ/spec/monitor/agent
        # individualItemDisabilityCheck: disableLableChecker
      - type: label-element
        label: Exporter Configuration
        schema: ''
      - type: switch
        label: Customize Exporter Sidecar
        schema: temp/properties/customizeExporter
        init: 
          type: static
          value: true
        watcher:
          func: onCustomizeExporterChange
          paths: 
            - temp/properties/customizeExporter
      - type: block-layout
        label: Customer Exporter Section 
        showLabels: false
        if:
          type: function
          name: showCustomizeExporterSection
        elements:
          - type: machine-compare
            label: Resources
            schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/resources
            if: 
              type: function
              name: returnFalse
          - type: label-element
            label: Security Context
            schema: ''
          - type: input
            schema:  schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/securityContext/properties/runAsUser
            label: Run as User
          - type: input
            schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/securityContext/properties/runAsGroup
            label: Run as Group
          - type: input
            schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/port
            label: Port
          - type: array-item-form
            label: Args
            schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/args
            init: 
              type: static
              value: ['--compatible-mode']
            element:
              type: input
              label: Args
              # isSubsection: true
          - type: block-layout
            label: Metadata
            showLabels: false
            elements: 
                #remove: should be array-object-form after fixes
              - type: block-layout
                label: New Environment Variable
                showLabels: true
                hideBlock: true
                # schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env
                elements:
                - type: input
                  label: Name
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/name
                - type: radio
                  label: Value From
                  schema: temp/properties/valueFromType
                  init: 
                    type: func 
                    value: setValueFrom
                  options:
                  - text: Input
                    value: input
                  - text: Secret
                    value: secret
                  - text: ConfigMap
                    value: configMap
                  watcher:
                    func: onValueFromChange
                    paths:
                      - temp/properties/valueFromType
                - type: input 
                  label: Value 
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/value
                  if:
                    name: isEqualToValueFromType|input
                    type: function
                - type: select
                  if:
                    type: function
                    name: isEqualToValueFromType|configMap
                  label: ConfigMap Name
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/valueFrom/properties/configMapKeyRef/properties/name
                  loader:
                    name: resourceNames|core|v1|configmaps
                    watchPaths:
                      - schema/metadata/release/namespace
                  # allowUserDefinedOption: true
                - type: select
                  label: ConfigMap Key
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/valueFrom/properties/configMapKeyRef/properties/key
                  if:
                    type: function
                    name: isEqualToValueFromType|configMap
                  loader:
                    name: getConfigMapKeys
                    watchPaths:
                      - schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/valueFrom/configMapKeyRef/name
                      - schema/metadata/release/namespace
                  # allowUserDefinedOption: true
                - type: select
                  label: Secret Name
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/valueFrom/properties/secretKeyRef/properties/name
                  if:
                    type: function
                    name: isEqualToValueFromType|secret
                  loader:
                    name: getSecrets
                    watchPaths:
                      - schema/metadata/release/namespace
                  # allowUserDefinedOption: true
                - type: select
                  label: Secret Key
                  schema: schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/properties/valueFrom/properties/secretKeyRef/properties/key
                  if:
                    type: function
                    name: isEqualToValueFromType|secret
                  loader:
                    name: getSecretKeys
                    watchPaths:
                      - schema/properties/resources/properties/kubedbComRabbitMQ/properties/spec/properties/monitor/properties/prometheus/properties/exporter/properties/env/properties/items/valueFrom/secretKeyRef/name
                      - schema/metadata/release/namespace
                  # allowUserDefinedOption: true



- type: single-step-form
  id: binding
  label: Gateway Binding
  elements:
  - type: switch
    label: Expose Database
    schema: temp/properties/binding
    fullwidth: true
    init:
      type: func
      value: isBindingAlreadyOn
    watcher:
      func: addOrRemoveBinding
      paths:
        - temp/properties/binding